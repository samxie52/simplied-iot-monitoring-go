<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket测试客户端</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .message-log {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            background-color: #f8f9fa;
            font-family: monospace;
            font-size: 12px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
        button {
            padding: 8px 16px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .device-data {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .device-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
        }
        .device-header {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        .sensor-data {
            margin: 5px 0;
            font-size: 14px;
        }
        .alert {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 10px;
            margin: 5px 0;
        }
        .alert.critical {
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
        .alert.warning {
            background-color: #fff3cd;
            border-color: #ffeaa7;
        }
        .alert.info {
            background-color: #d1ecf1;
            border-color: #bee5eb;
        }
    </style>
</head>
<body>
    <h1>Industrial IoT WebSocket测试客户端</h1>
    
    <div id="status" class="status disconnected">
        状态: 未连接
    </div>
    
    <div>
        <button id="connectBtn" onclick="connect()">连接</button>
        <button id="disconnectBtn" onclick="disconnect()" disabled>断开</button>
        <button onclick="sendPing()">发送Ping</button>
        <button onclick="clearLog()">清空日志</button>
        <button onclick="clearDevices()">清空设备</button>
    </div>
    
    <div class="stats">
        <div class="stat-card">
            <h3>接收消息数</h3>
            <div class="stat-value" id="receivedCount">0</div>
        </div>
        <div class="stat-card">
            <h3>设备数量</h3>
            <div class="stat-value" id="deviceCount">0</div>
        </div>
        <div class="stat-card">
            <h3>告警数量</h3>
            <div class="stat-value" id="alertCount">0</div>
        </div>
        <div class="stat-card">
            <h3>连接时间</h3>
            <div class="stat-value" id="connectionTime">-</div>
        </div>
    </div>
    
    <h3>实时设备数据:</h3>
    <div id="deviceData" class="device-data"></div>
    
    <h3>告警信息:</h3>
    <div id="alertData"></div>
    
    <h3>消息日志:</h3>
    <div id="messageLog" class="message-log"></div>

    <script>
        let ws = null;
        let receivedCount = 0;
        let deviceCount = 0;
        let alertCount = 0;
        let connectionStartTime = null;
        let devices = new Map();
        let alerts = [];

        function log(message) {
            const messageLog = document.getElementById('messageLog');
            const timestamp = new Date().toLocaleTimeString();
            messageLog.innerHTML += `[${timestamp}] ${message}\n`;
            messageLog.scrollTop = messageLog.scrollHeight;
        }

        function updateStatus(connected) {
            const statusDiv = document.getElementById('status');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            
            if (connected) {
                statusDiv.textContent = '状态: 已连接';
                statusDiv.className = 'status connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else {
                statusDiv.textContent = '状态: 未连接';
                statusDiv.className = 'status disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            }
        }

        function updateStats() {
            document.getElementById('receivedCount').textContent = receivedCount;
            document.getElementById('deviceCount').textContent = deviceCount;
            document.getElementById('alertCount').textContent = alertCount;
            
            if (connectionStartTime) {
                const duration = Math.floor((Date.now() - connectionStartTime) / 1000);
                document.getElementById('connectionTime').textContent = `${duration}秒`;
            }
        }

        function updateDeviceDisplay() {
            const deviceDataDiv = document.getElementById('deviceData');
            deviceDataDiv.innerHTML = '';
            
            devices.forEach((device, deviceId) => {
                const deviceCard = document.createElement('div');
                deviceCard.className = 'device-card';
                
                let sensorsHtml = '';
                if (device.sensors) {
                    for (const [sensorType, sensorData] of Object.entries(device.sensors)) {
                        if (sensorData.value !== undefined) {
                            sensorsHtml += `<div class="sensor-data">${sensorType}: ${sensorData.value}${sensorData.unit || ''} (${sensorData.status})</div>`;
                        }
                    }
                }
                
                deviceCard.innerHTML = `
                    <div class="device-header">${device.device_id} (${device.device_type})</div>
                    <div>位置: ${device.location?.building} - ${device.location?.floor}楼 - ${device.location?.room}</div>
                    <div>状态: ${device.status}</div>
                    <div>时间: ${new Date(device.timestamp).toLocaleTimeString()}</div>
                    ${sensorsHtml}
                `;
                
                deviceDataDiv.appendChild(deviceCard);
            });
            
            deviceCount = devices.size;
            updateStats();
        }

        function updateAlertDisplay() {
            const alertDataDiv = document.getElementById('alertData');
            alertDataDiv.innerHTML = '';
            
            alerts.slice(-10).forEach(alert => {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert ${alert.severity}`;
                alertDiv.innerHTML = `
                    <strong>[${alert.severity.toUpperCase()}]</strong> 
                    设备: ${alert.device_id} - ${alert.message}
                    <br><small>时间: ${new Date(alert.timestamp).toLocaleString()}</small>
                `;
                alertDataDiv.appendChild(alertDiv);
            });
        }

        function connect() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                log('WebSocket已经连接');
                return;
            }

            const wsUrl = 'ws://localhost:8090/ws';
            log(`正在连接到: ${wsUrl}`);
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function(event) {
                log('WebSocket连接成功');
                updateStatus(true);
                connectionStartTime = Date.now();
                updateStats();
            };
            
            ws.onmessage = function(event) {
                receivedCount++;
                updateStats();
                
                try {
                    const message = JSON.parse(event.data);
                    log(`收到消息类型: ${message.type}`);
                    
                    if (message.type === 'device_data') {
                        const device = message.data;
                        devices.set(device.device_id, device);
                        updateDeviceDisplay();
                        log(`设备数据: ${device.device_id} (${device.device_type})`);
                    } else if (message.type === 'alert') {
                        const alert = message.data;
                        alerts.push(alert);
                        alertCount = alerts.length;
                        updateAlertDisplay();
                        updateStats();
                        log(`告警: ${alert.device_id} - ${alert.severity} - ${alert.message}`);
                    } else if (message.type === 'pong') {
                        log(`收到Pong响应: ${message.timestamp}`);
                    } else {
                        log(`未知消息类型: ${message.type}`);
                    }
                } catch (error) {
                    log(`JSON解析错误: ${error.message}`);
                    log(`原始消息: ${event.data}`);
                }
            };
            
            ws.onclose = function(event) {
                log(`WebSocket连接关闭: code=${event.code}, reason=${event.reason}`);
                updateStatus(false);
                connectionStartTime = null;
                updateStats();
            };
            
            ws.onerror = function(error) {
                log(`WebSocket错误: ${error}`);
                updateStatus(false);
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        function sendPing() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const pingMessage = {
                    type: 'ping',
                    timestamp: Date.now()
                };
                ws.send(JSON.stringify(pingMessage));
                log(`发送Ping: ${JSON.stringify(pingMessage)}`);
            } else {
                log('WebSocket未连接，无法发送消息');
            }
        }

        function clearLog() {
            document.getElementById('messageLog').innerHTML = '';
        }

        function clearDevices() {
            devices.clear();
            alerts = [];
            alertCount = 0;
            updateDeviceDisplay();
            updateAlertDisplay();
            updateStats();
            log('清空设备和告警数据');
        }

        // 页面加载时自动连接
        window.onload = function() {
            log('页面加载完成，准备测试WebSocket连接');
            // 自动连接
            setTimeout(connect, 1000);
            
            // 定时更新连接时间
            setInterval(updateStats, 1000);
        };
    </script>
</body>
</html>
