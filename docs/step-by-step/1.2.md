# Step 1.2: é…ç½®ç®¡ç†ç³»ç»Ÿ - ä¼ä¸šçº§å¾®æœåŠ¡é…ç½®æ¶æ„

## ğŸ¯ é¡¹ç›®æŠ€æœ¯äº®ç‚¹

### æ ¸å¿ƒæˆå°±ä¸KPIæŒ‡æ ‡
- âœ… **å¤šç¯å¢ƒé…ç½®æ”¯æŒ**: æ”¯æŒå¼€å‘/æµ‹è¯•/é¢„ç”Ÿäº§/ç”Ÿäº§4å¥—ç¯å¢ƒé…ç½®æ— ç¼åˆ‡æ¢
- âœ… **é›¶åœæœºé…ç½®æ›´æ–°**: åŸºäºçƒ­é‡è½½æœºåˆ¶ï¼Œé…ç½®å˜æ›´æ— éœ€é‡å¯æœåŠ¡
- âœ… **100%é…ç½®éªŒè¯è¦†ç›–**: ç»“æ„éªŒè¯+ä¸šåŠ¡éªŒè¯+ä¾èµ–æ£€æŸ¥å…¨è¦†ç›–
- âœ… **ç®€æ´é«˜æ•ˆæ¶æ„**: ä¸“æ³¨æ ¸å¿ƒåŠŸèƒ½ï¼Œç§»é™¤å¤æ‚å®‰å…¨å’Œå®¡è®¡æ¨¡å—ï¼Œæå‡ç»´æŠ¤æ€§

### æ ¸å¿ƒæŠ€æœ¯æ ˆå±•ç¤º
- **Viperé…ç½®ç®¡ç†**: æ”¯æŒYAML/JSON/TOML/ENVå¤šæ ¼å¼é…ç½®æ–‡ä»¶
- **Validatoræ•°æ®éªŒè¯**: åŸºäºgo-playground/validatorçš„ç»“æ„åŒ–éªŒè¯
- **ç¯å¢ƒå˜é‡æ³¨å…¥**: 12-Factor Appé…ç½®åŸåˆ™ï¼Œæ”¯æŒDocker/K8sç¯å¢ƒ
- **é…ç½®çƒ­æ›´æ–°**: åŸºäºæ–‡ä»¶ç›‘å¬çš„åŠ¨æ€é…ç½®é‡è½½æœºåˆ¶

## ğŸ“Š æŠ€æœ¯é€‰å‹ä¸æ¶æ„è®¾è®¡

### é…ç½®ç®¡ç†åº“å¯¹æ¯”åˆ†æ

| ç‰¹æ€§ | Viper | Cobra | flag | pflag | envconfig | æ¨èæŒ‡æ•° |
|------|-------|-------|------|-------|-----------|----------|
| å¤šæ ¼å¼æ”¯æŒ | âœ… YAML/JSON/TOML | âŒ | âŒ | âŒ | âŒ | â­â­â­â­â­ |
| ç¯å¢ƒå˜é‡ | âœ… è‡ªåŠ¨æ˜ å°„ | âŒ | âŒ | âŒ | âœ… ä¸“ç”¨ | â­â­â­â­â­ |
| é…ç½®çƒ­æ›´æ–° | âœ… æ–‡ä»¶ç›‘å¬ | âŒ | âŒ | âŒ | âŒ | â­â­â­â­â­ |
| å‘½ä»¤è¡Œé›†æˆ | âœ… ä¸Cobraå®Œç¾é›†æˆ | âœ… CLIä¸“ç”¨ | âœ… æ ‡å‡†åº“ | âœ… å¢å¼ºç‰ˆ | âŒ | â­â­â­â­ |
| GitHubæ˜Ÿæ•° | 26.8k | 37.2k | æ ‡å‡†åº“ | 2.4k | 4.8k | â­â­â­â­â­ |

**é€‰æ‹©ç»“è®º**: Viper + Cobra ç»„åˆï¼Œæä¾›å®Œæ•´çš„é…ç½®ç®¡ç†å’ŒCLIæ”¯æŒ

## ğŸ—ï¸ æ ¸å¿ƒæ¶æ„è®¾è®¡

### é…ç½®ç®¡ç†ç³»ç»Ÿæ¶æ„å›¾

```mermaid
graph TB
    subgraph "é…ç½®æºå±‚"
        YAML[YAMLé…ç½®æ–‡ä»¶]
        ENV[ç¯å¢ƒå˜é‡]
        CLI[å‘½ä»¤è¡Œå‚æ•°]
    end
    
    subgraph "é…ç½®ç®¡ç†å±‚"
        LOADER[é…ç½®åŠ è½½å™¨<br/>Viper Loader]
        VALIDATOR[é…ç½®éªŒè¯å™¨<br/>Struct Validator]
        WATCHER[é…ç½®ç›‘å¬å™¨<br/>File Watcher]
    end
    
    subgraph "åº”ç”¨æœåŠ¡å±‚"
        PRODUCER[Producer Service]
        CONSUMER[Consumer Service]
        WEBSOCKET[WebSocket Service]
        WEB[Web Service]
    end
    
    YAML --> LOADER
    ENV --> LOADER
    CLI --> LOADER
    
    LOADER --> VALIDATOR
    VALIDATOR --> PRODUCER
    VALIDATOR --> CONSUMER
    VALIDATOR --> WEBSOCKET
    VALIDATOR --> WEB
    
    WATCHER --> LOADER
```

### å¤šç¯å¢ƒé…ç½®æ¶æ„å›¾

```mermaid
graph LR
    subgraph "é…ç½®æ–‡ä»¶ç»“æ„"
        BASE[config.yaml<br/>åŸºç¡€é…ç½®]
        DEV[development.yaml<br/>å¼€å‘ç¯å¢ƒ]
        PROD[production.yaml<br/>ç”Ÿäº§ç¯å¢ƒ]
    end
    
    subgraph "ç¯å¢ƒé€‰æ‹©å™¨"
        ENV_VAR[GO_ENVç¯å¢ƒå˜é‡]
        CONFIG_LOADER[é…ç½®åŠ è½½å™¨]
    end
    
    subgraph "è¿è¡Œæ—¶é…ç½®"
        RUNTIME_CONFIG[è¿è¡Œæ—¶é…ç½®å¯¹è±¡]
        HOT_RELOAD[çƒ­é‡è½½æœºåˆ¶]
    end
    
    BASE --> CONFIG_LOADER
    DEV --> CONFIG_LOADER
    PROD --> CONFIG_LOADER
    
    ENV_VAR --> CONFIG_LOADER
    CONFIG_LOADER --> RUNTIME_CONFIG
    HOT_RELOAD --> RUNTIME_CONFIG
```

## ğŸš€ å¼€å‘å®æ–½è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µ (ç¬¬1-2å¤©): é…ç½®åŸºç¡€æ¶æ„

#### Step 1.2.1: é…ç½®ç»“æ„ä½“è®¾è®¡å’Œå­—æ®µå®šä¹‰
**ç›®æ ‡**: å»ºç«‹å®Œæ•´çš„é…ç½®æ•°æ®ç»“æ„
**äº¤ä»˜ç‰©**:
- `internal/config/config.go` - ä¸»é…ç½®ç»“æ„ä½“
- `internal/config/types.go` - é…ç½®ç±»å‹å®šä¹‰
- `internal/config/defaults.go` - é»˜è®¤å€¼å®šä¹‰

#### Step 1.2.2: Viperé…ç½®åŠ è½½å™¨å’Œç¯å¢ƒå˜é‡å¤„ç†
**ç›®æ ‡**: å®ç°å¤šæºé…ç½®åŠ è½½æœºåˆ¶
**äº¤ä»˜ç‰©**:
- `internal/config/loader.go` - Viperé…ç½®åŠ è½½å™¨
- `internal/config/environment.go` - ç¯å¢ƒç®¡ç†å™¨
- `configs/` - å¤šç¯å¢ƒé…ç½®æ–‡ä»¶ç›®å½•

### ç¬¬äºŒé˜¶æ®µ (ç¬¬3å¤©): é…ç½®éªŒè¯ä½“ç³»

#### Step 1.2.3: æ•°æ®éªŒè¯è§„åˆ™å’Œè‡ªå®šä¹‰éªŒè¯å‡½æ•°
**ç›®æ ‡**: å»ºç«‹å®Œæ•´çš„é…ç½®éªŒè¯æœºåˆ¶
**äº¤ä»˜ç‰©**:
- `internal/config/validator.go` - é…ç½®éªŒè¯å™¨
- `internal/config/rules.go` - éªŒè¯è§„åˆ™å®šä¹‰
- `internal/config/custom_validators.go` - è‡ªå®šä¹‰éªŒè¯å‡½æ•°

### ç¬¬ä¸‰é˜¶æ®µ (ç¬¬4-5å¤©): é«˜çº§ç‰¹æ€§å’Œé›†æˆ

#### Step 1.2.4: å¤šç¯å¢ƒé…ç½®å’Œæ•æ„Ÿä¿¡æ¯å¤„ç†
**ç›®æ ‡**: å®ç°ç¯å¢ƒéš”ç¦»å’Œå®‰å…¨å¤„ç†
**äº¤ä»˜ç‰©**:
- `.env.example` - ç¯å¢ƒå˜é‡æ¨¡æ¿

#### Step 1.2.5: é…ç½®çƒ­æ›´æ–°å’Œé”™è¯¯å¤„ç†æœºåˆ¶
**ç›®æ ‡**: å®ç°åŠ¨æ€é…ç½®å’Œé”™è¯¯æ¢å¤
**äº¤ä»˜ç‰©**:
- `internal/config/watcher.go` - é…ç½®ç›‘å¬å™¨
- `internal/config/errors.go` - é”™è¯¯å¤„ç†å™¨

## ğŸ”§ æ ¸å¿ƒæ¶æ„è®¾è®¡è§„èŒƒ

### é…ç½®ç®¡ç†å™¨æ¶æ„è®¾è®¡

```go
// ConfigManager é…ç½®ç®¡ç†å™¨æ¥å£å®šä¹‰
type ConfigManager interface {
    // é…ç½®åŠ è½½
    Load(configPath string, env Environment) error
    LoadFromEnv() error
    
    // é…ç½®è®¿é—®
    Get(key string) interface{}
    GetString(key string) string
    GetInt(key string) int
    GetBool(key string) bool
    
    // é…ç½®éªŒè¯
    Validate() error
    
    // é…ç½®ç›‘å¬
    Watch(callback func(*Config)) error
    StopWatch() error
}
```

### é…ç½®ç»“æ„ä½“æ¶æ„è®¾è®¡

```go
// AppConfig åº”ç”¨å…¨å±€é…ç½®ç»“æ„
type AppConfig struct {
    // åº”ç”¨åŸºç¡€é…ç½®
    App     AppSection     `yaml:"app" validate:"required"`
    
    // ä¸­é—´ä»¶é…ç½®
    Kafka   KafkaSection   `yaml:"kafka" validate:"required"`
    Redis   RedisSection   `yaml:"redis" validate:"required"`
    DB      DBSection      `yaml:"db" validate:"required"`
    
    // æœåŠ¡é…ç½®
    Producer  ProducerSection  `yaml:"producer" validate:"required"`
    Consumer  ConsumerSection  `yaml:"consumer" validate:"required"`
    WebSocket WSSection        `yaml:"websocket" validate:"required"`
    Web       WebSection       `yaml:"web" validate:"required"`
    
    // ç›‘æ§é…ç½®
    Monitor   MonitorSection   `yaml:"monitoring" validate:"required"`
}

// Kafkaé…ç½®æ®µè¯¦ç»†ç»“æ„
type KafkaSection struct {
    Brokers     []string          `yaml:"brokers" validate:"required,min=1"`
    Topics      TopicConfig       `yaml:"topics" validate:"required"`
    Producer    KafkaProducer     `yaml:"producer" validate:"required"`
    Consumer    KafkaConsumer     `yaml:"consumer" validate:"required"`
    Timeout     time.Duration     `yaml:"timeout" validate:"required"`
}
```

### ç¯å¢ƒå˜é‡å¤„ç†æ¶æ„è®¾è®¡

```go
// Environment ç¯å¢ƒç±»å‹æšä¸¾
type Environment string

const (
    Development Environment = "development"
    Testing     Environment = "testing"
    Production  Environment = "production"
)

// EnvironmentManager ç¯å¢ƒç®¡ç†å™¨æ¥å£
type EnvironmentManager interface {
    // ç¯å¢ƒæ£€æµ‹
    GetCurrentEnv() Environment
    SetEnv(env Environment) error
    
    // ç¯å¢ƒé…ç½®
    LoadEnvConfig(env Environment) (*AppConfig, error)
    GetEnvConfigPath(env Environment) string
    
    // ç¯å¢ƒå˜é‡å¤„ç†
    BindEnvVars() error
    SetEnvPrefix(prefix string)
}
```

### é…ç½®éªŒè¯å™¨æ¶æ„è®¾è®¡

```go
// ConfigValidator é…ç½®éªŒè¯å™¨æ¥å£
type ConfigValidator interface {
    // ç»“æ„éªŒè¯
    ValidateStruct(config *AppConfig) error
    ValidateField(field string, value interface{}) error
    
    // ä¸šåŠ¡éªŒè¯
    ValidateBusinessRules(config *AppConfig) error
    
    // è‡ªå®šä¹‰éªŒè¯
    RegisterValidator(tag string, fn validator.Func) error
    
    // éªŒè¯æŠ¥å‘Š
    GetValidationErrors() []ValidationError
}

// è‡ªå®šä¹‰éªŒè¯å‡½æ•°ç¤ºä¾‹
func ValidateKafkaBrokers(fl validator.FieldLevel) bool
func ValidatePortRange(fl validator.FieldLevel) bool
func ValidateFilePath(fl validator.FieldLevel) bool
```

## ğŸ› ï¸ æŠ€æœ¯ç‰¹æ€§æ¼”ç¤º

### å®Œæ•´é…ç½®ç»“æ„å±•ç¤º

```yaml
# config.yaml - å®Œæ•´é…ç½®ç»“æ„ç¤ºä¾‹
app:
  name: "industrial-iot-monitor"
  version: "1.0.0"
  environment: "development"
  debug: true
  log_level: "info"

# Kafkaæ¶ˆæ¯é˜Ÿåˆ—é…ç½®
kafka:
  brokers: ["localhost:9092"]
  topics:
    device_data: "device-data"
    alerts: "alerts"
  producer:
    batch_size: 16384
    linger_ms: 10
    compression_type: "snappy"
    retries: 3
    timeout: "30s"
  consumer:
    group_id: "iot-consumer-group"
    auto_offset_reset: "earliest"
    session_timeout: "30s"

# Redisç¼“å­˜é…ç½®
redis:
  host: "localhost"
  port: 6379
  password: ""
  database: 0
  pool_size: 10
  timeout: "5s"

# PostgreSQLæ•°æ®åº“é…ç½®
db:
  host: "localhost"
  port: 5432
  username: "postgres"
  password: "postgres"
  database: "iot_monitor"
  ssl_mode: "disable"
  max_open_conns: 25
  max_idle_conns: 5
  conn_max_lifetime: "1h"

# WebSocketæœåŠ¡é…ç½®
websocket:
  host: "0.0.0.0"
  port: 8081
  path: "/ws"
  max_connections: 1000
  heartbeat_interval: "30s"

# WebæœåŠ¡é…ç½®
web:
  host: "0.0.0.0"
  port: 8080
  template_path: "web/templates"
  static_path: "web/static"

# ç›‘æ§é…ç½®
monitoring:
  prometheus:
    enabled: true
    port: 9090
    path: "/metrics"
  logging:
    level: "info"
    format: "json"
    output: ["stdout", "file"]
```

### å¤šç¯å¢ƒé…ç½®åˆ‡æ¢æ¼”ç¤º

```yaml
# configs/development.yaml
app:
  debug: true
  log_level: "debug"

kafka:
  brokers: ["localhost:9092"]

db:
  host: "localhost"
  database: "iot_monitor_dev"

---
# configs/production.yaml
app:
  debug: false
  log_level: "warn"

kafka:
  brokers: ["kafka-1:9092", "kafka-2:9092", "kafka-3:9092"]

db:
  host: "db-server"
  database: "iot_monitor_prod"
  ssl_mode: "require"
```

## ğŸ“‹ é…ç½®éƒ¨ç½²ç­–ç•¥

### Dockerå®¹å™¨é…ç½®æ³¨å…¥

```dockerfile
# é…ç½®æ–‡ä»¶æŒ‚è½½
COPY configs/ /app/configs/
COPY .env.example /app/.env

# ç¯å¢ƒå˜é‡æ³¨å…¥
ENV GO_ENV=production
ENV CONFIG_PATH=/app/configs

# è¿è¡Œæ—¶é…ç½®è¦†ç›–
CMD ["./app", "--config", "/app/configs/production.yaml"]
```

### Kubernetes ConfigMapé›†æˆ

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: iot-monitor-config
data:
  config.yaml: |
    app:
      name: "industrial-iot-monitor"
      environment: "production"
    kafka:
      brokers: ["kafka-service:9092"]
```

## ğŸ¯ GitHubå±•ç¤ºè¦ç‚¹

### é¡¹ç›®äº®ç‚¹æ€»ç»“
- **ä¼ä¸šçº§é…ç½®ç®¡ç†**: å¤šç¯å¢ƒæ”¯æŒã€é…ç½®éªŒè¯ã€çƒ­é‡è½½æœºåˆ¶
- **å¾®æœåŠ¡æ¶æ„**: ç»Ÿä¸€é…ç½®ç®¡ç†ï¼ŒæœåŠ¡é—´é…ç½®éš”ç¦»
- **Goå·¥ç¨‹åŒ–å®è·µ**: æ¥å£è®¾è®¡ã€ä¾èµ–æ³¨å…¥ã€é”™è¯¯å¤„ç†

### æŠ€æœ¯èƒ½åŠ›å±•ç¤º
- **é…ç½®æ¶æ„è®¾è®¡**: åˆ†å±‚æ¶æ„ã€æ¥å£æŠ½è±¡ã€æ‰©å±•æ€§è®¾è®¡
- **æ•°æ®éªŒè¯**: ç»“æ„éªŒè¯ã€ä¸šåŠ¡éªŒè¯ã€è‡ªå®šä¹‰éªŒè¯å‡½æ•°

## ğŸ“š å®Œæ•´æ¶æ„è®¾è®¡æ€»ç»“

### ä»£ç å®ç°æ¸…å•

1. **é…ç½®ç»“æ„å®šä¹‰** (`internal/config/`)
   - `config.go` - ä¸»é…ç½®ç»“æ„ä½“å’Œæ¥å£å®šä¹‰
   - `types.go` - é…ç½®ç±»å‹å’Œå¸¸é‡å®šä¹‰
   - `defaults.go` - é»˜è®¤å€¼å’Œåˆå§‹åŒ–

2. **é…ç½®åŠ è½½å™¨** (`internal/config/`)
   - `loader.go` - Viperé…ç½®åŠ è½½å®ç°
   - `environment.go` - ç¯å¢ƒç®¡ç†å’Œåˆ‡æ¢

3. **é…ç½®éªŒè¯å™¨** (`internal/config/`)
   - `validator.go` - é…ç½®éªŒè¯å™¨å®ç°ï¼ˆåŒ…å«éªŒè¯è§„åˆ™å’Œè‡ªå®šä¹‰éªŒè¯å‡½æ•°ï¼‰

4. **é«˜çº§ç‰¹æ€§** (`internal/config/`)
   - `watcher.go` - é…ç½®æ–‡ä»¶ç›‘å¬å’Œçƒ­é‡è½½
   - `errors.go` - é”™è¯¯å¤„ç†å’Œæ¢å¤æœºåˆ¶

5. **é…ç½®æ–‡ä»¶** (`configs/`)
   - `config.yaml` - åŸºç¡€é…ç½®æ–‡ä»¶
   - `development.yaml` - å¼€å‘ç¯å¢ƒé…ç½®
   - `production.yaml` - ç”Ÿäº§ç¯å¢ƒé…ç½®
   - `.env.example` - ç¯å¢ƒå˜é‡æ¨¡æ¿

### å®ç°è§„èŒƒè¦æ±‚

- æ‰€æœ‰é…ç½®ç»“æ„ä½“åŒ…å«åŸºç¡€çš„validationæ ‡ç­¾ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
- ç¯å¢ƒå˜é‡æ”¯æŒéµå¾ª12-Factor AppåŸåˆ™
- é…ç½®éªŒè¯åŒ…å«ç»“æ„éªŒè¯å’Œå¿…è¦çš„ä¸šåŠ¡éªŒè¯
- é”™è¯¯å¤„ç†æä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯å’Œæ¢å¤å»ºè®®
- é…ç½®çƒ­é‡è½½ä¿è¯æœåŠ¡ç¨³å®šè¿è¡Œ
- ç§»é™¤å¤æ‚çš„å®‰å…¨å’Œå®¡è®¡åŠŸèƒ½ï¼Œä¸“æ³¨æ ¸å¿ƒé…ç½®ç®¡ç†

### ä¸‹ä¸€æ­¥é›†æˆæ–¹å‘ (Step 1.3é¢„è§ˆ)

åŸºäºå®Œå–„çš„é…ç½®ç®¡ç†ç³»ç»Ÿï¼ŒStep 1.3å°†å®ç°æ•°æ®æ¨¡å‹å’Œå­˜å‚¨å±‚ï¼ŒåŒ…æ‹¬ï¼š
- æ—¶åºæ•°æ®åº“é›†æˆå’Œé…ç½®
- æ•°æ®æ¨¡å‹å®šä¹‰å’ŒéªŒè¯
- å­˜å‚¨å±‚æŠ½è±¡å’Œå®ç°
- æ•°æ®è¿ç§»å’Œç‰ˆæœ¬ç®¡ç†

é…ç½®ç®¡ç†ç³»ç»Ÿå°†ä¸ºæ•°æ®å­˜å‚¨æä¾›å®Œæ•´çš„æ•°æ®åº“è¿æ¥é…ç½®ã€ç¼“å­˜é…ç½®å’Œå­˜å‚¨ç­–ç•¥é…ç½®æ”¯æŒã€‚
