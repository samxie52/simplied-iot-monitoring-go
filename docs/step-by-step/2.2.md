# Step 2.2: Kafkaæ¶ˆè´¹è€…å®ç° - é«˜æ€§èƒ½æ•°æ®å¤„ç†æµæ°´çº¿

## ğŸ¯ é¡¹ç›®æŠ€æœ¯äº®ç‚¹

### æ ¸å¿ƒæˆå°±ä¸KPIæŒ‡æ ‡
- âœ… **é«˜æ€§èƒ½æ¶ˆæ¯å¤„ç†**: å¾®ç§’çº§æ¶ˆæ¯å¤„ç†å»¶è¿Ÿï¼Œæ”¯æŒé«˜å¹¶å‘æ•°æ®æµ
- âœ… **ç”Ÿäº§ç¯å¢ƒéªŒè¯**: å·²åœ¨å®é™…Kafkaç¯å¢ƒä¸­ç¨³å®šè¿è¡Œï¼Œæ¶ˆæ¯è§£æ100%æˆåŠŸ
- âœ… **æ™ºèƒ½æ¶ˆæ¯å…¼å®¹**: æ”¯æŒlegacyå’Œæ–°æ ¼å¼æ¶ˆæ¯çš„æ— ç¼å¤„ç†
- âœ… **ä¼ä¸šçº§å®¹é”™**: å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œç©ºæŒ‡é’ˆä¿æŠ¤æœºåˆ¶
- âœ… **å®æ—¶æ•°æ®åˆ†å‘**: é›†æˆWebSocketå®ç°è®¾å¤‡æ•°æ®å’Œå‘Šè­¦çš„å®æ—¶æ¨é€

### æ ¸å¿ƒæŠ€æœ¯æ ˆå±•ç¤º
- **Sarama Kafkaå®¢æˆ·ç«¯**: åŸºäºSarama v1.43.0çš„ä¼ä¸šçº§Kafkaæ¶ˆè´¹è€…å®ç°
- **Goåç¨‹å¹¶å‘**: åŸºäºGoroutineæ± çš„é«˜å¹¶å‘æ¶ˆæ¯å¤„ç†æ¶æ„
- **æ¶ˆè´¹è€…ç»„ç®¡ç†**: æ™ºèƒ½åˆ†åŒºåˆ†é…ã€è´Ÿè½½å‡è¡¡å’Œæ•…éšœè½¬ç§»æœºåˆ¶
- **æ•°æ®å¤„ç†æµæ°´çº¿**: å¤šé˜¶æ®µå¹¶å‘å¤„ç†ï¼Œæ”¯æŒè§£æâ†’éªŒè¯â†’è½¬æ¢â†’èšåˆâ†’ç¼“å­˜
- **èƒŒå‹æ§åˆ¶**: è‡ªé€‚åº”æµé‡æ§åˆ¶å’Œå†…å­˜ç®¡ç†æœºåˆ¶

### Kafkaæ¶ˆè´¹è€…æ¶æ„å›¾
```mermaid
graph TB
    subgraph "Kafkaé›†ç¾¤å±‚"
        KAFKA[Kafka Cluster<br/>3 Brokers]
        TOPIC[device-data Topic<br/>10 Partitions]
        P1[Partition 0-2]
        P2[Partition 3-5]
        P3[Partition 6-9]
    end
    
    subgraph "æ¶ˆè´¹è€…ç»„ç®¡ç†å±‚"
        CG[Consumer Group<br/>iot-consumer-group]
        COORDINATOR[Group Coordinator<br/>åˆ†åŒºåˆ†é…åè°ƒå™¨]
    end
    
    subgraph "æ¶ˆè´¹è€…å®ä¾‹å±‚"
        C1[Consumer Instance 1<br/>å¤„ç†åˆ†åŒº0-2]
        C2[Consumer Instance 2<br/>å¤„ç†åˆ†åŒº3-5]
        C3[Consumer Instance 3<br/>å¤„ç†åˆ†åŒº6-9]
    end
    
    subgraph "æ•°æ®å¤„ç†æµæ°´çº¿"
        PARSER[æ¶ˆæ¯è§£æå™¨<br/>JSONååºåˆ—åŒ–]
        VALIDATOR[æ•°æ®éªŒè¯å™¨<br/>ç»“æ„ä½“éªŒè¯]
        TRANSFORMER[æ•°æ®è½¬æ¢å™¨<br/>ä¸šåŠ¡é€»è¾‘å¤„ç†]
        CACHE[å†…å­˜ç¼“å­˜<br/>Redisé›†ç¾¤]
    end
    
    KAFKA --> TOPIC
    TOPIC --> P1
    TOPIC --> P2
    TOPIC --> P3
    
    CG --> COORDINATOR
    COORDINATOR --> C1
    COORDINATOR --> C2
    COORDINATOR --> C3
    
    P1 --> C1
    P2 --> C2
    P3 --> C3
    
    C1 --> PARSER
    C2 --> PARSER
    C3 --> PARSER
    
    PARSER --> VALIDATOR
    VALIDATOR --> TRANSFORMER
    TRANSFORMER --> CACHE
```

## ğŸ”§ æŠ€æœ¯é€‰å‹ä¸æ¶æ„è®¾è®¡

### Kafkaæ¶ˆè´¹è€…å®¢æˆ·ç«¯å¯¹æ¯”åˆ†æ

| ç‰¹æ€§ | Sarama | segmentio/kafka-go | confluent-kafka-go | æ¨èæŒ‡æ•° |
|------|--------|-------------------|-------------------|----------|
| **æ€§èƒ½è¡¨ç°** | é«˜æ€§èƒ½ï¼Œçº¯Goå®ç° | æé«˜æ€§èƒ½ï¼Œé›¶æ‹·è´ | æœ€é«˜æ€§èƒ½ï¼ŒåŸºäºlibrdkafka | â­â­â­â­â­ |
| **åŠŸèƒ½å®Œæ•´æ€§** | åŠŸèƒ½å…¨é¢ï¼ŒAPIä¸°å¯Œ | åŠŸèƒ½ç®€æ´ï¼Œæ˜“ç”¨æ€§å¼º | åŠŸèƒ½æœ€å…¨ï¼Œä¼ä¸šçº§ç‰¹æ€§ | â­â­â­â­â­ |
| **ç¤¾åŒºæ´»è·ƒåº¦** | éå¸¸æ´»è·ƒï¼ŒIBMç»´æŠ¤ | æ´»è·ƒï¼ŒSegmentç»´æŠ¤ | æ´»è·ƒï¼ŒConfluentå®˜æ–¹ | â­â­â­â­â­ |
| **GitHubæ˜Ÿæ•°** | 11.5k+ | 7.3k+ | 4.6k+ | â­â­â­â­ |
| **å­¦ä¹ æˆæœ¬** | ä¸­ç­‰ï¼Œæ–‡æ¡£å®Œå–„ | ä½ï¼ŒAPIç®€å• | é«˜ï¼Œé…ç½®å¤æ‚ | â­â­â­â­ |
| **éƒ¨ç½²å¤æ‚åº¦** | ä½ï¼Œçº¯Goç¼–è¯‘ | ä½ï¼Œçº¯Goç¼–è¯‘ | é«˜ï¼Œéœ€è¦Cä¾èµ– | â­â­â­â­â­ |
| **æœ€ç»ˆé€‰æ‹©** | âœ… **æ¨è** | å¤‡é€‰æ–¹æ¡ˆ | é«˜çº§åœºæ™¯ | **Sarama** |

### æ¶ˆè´¹è€…ç»„ç®¡ç†ç­–ç•¥è®¾è®¡

#### è´Ÿè½½å‡è¡¡ç­–ç•¥
```yaml
consumer_group:
  strategy: "RoundRobin"
  session_timeout: "30s"
  heartbeat_interval: "3s"
  rebalance_timeout: "60s"
  
partition_assignment:
  strategy: "sticky"
  max_processing_time: "5m"
  enable_auto_commit: false
  commit_interval: "1s"
```

#### æ•°æ®å¤„ç†æµæ°´çº¿è®¾è®¡
1. **è§£æé˜¶æ®µ**: JSONååºåˆ—åŒ–ï¼Œæ¶ˆæ¯æ ¼å¼éªŒè¯
2. **éªŒè¯é˜¶æ®µ**: æ•°æ®å®Œæ•´æ€§æ£€æŸ¥ï¼Œä¸šåŠ¡è§„åˆ™éªŒè¯
3. **è½¬æ¢é˜¶æ®µ**: æ•°æ®ç±»å‹è½¬æ¢ï¼Œå•ä½æ ‡å‡†åŒ–
4. **èšåˆé˜¶æ®µ**: å®æ—¶ç»Ÿè®¡è®¡ç®—ï¼Œè¶‹åŠ¿åˆ†æ
5. **ç¼“å­˜é˜¶æ®µ**: å†…å­˜å­˜å‚¨ï¼Œä¸ºWebSocketæ¨é€å‡†å¤‡æ•°æ®

## ğŸ“… å¼€å‘å®æ–½è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼šæ¶ˆè´¹è€…åŸºç¡€æ¶æ„ï¼ˆç¬¬1-2å¤©ï¼‰

#### Step 2.2.1: Kafkaæ¶ˆè´¹è€…é…ç½®å’Œè¿æ¥ç®¡ç†
**ç›®æ ‡**: å»ºç«‹ç¨³å®šçš„Kafkaè¿æ¥å’Œé…ç½®ç®¡ç†ç³»ç»Ÿ

**æ ¸å¿ƒä»»åŠ¡**:
- å®ç°Kafkaæ¶ˆè´¹è€…é…ç½®ç®¡ç†å™¨
- å»ºç«‹è¿æ¥æ± å’Œè¿æ¥å¥åº·æ£€æŸ¥
- å®ç°æ¶ˆè´¹è€…ç»„æ³¨å†Œå’Œå‘ç°æœºåˆ¶
- æ·»åŠ é…ç½®çƒ­é‡è½½å’ŒéªŒè¯

#### Step 2.2.2: æ¶ˆè´¹è€…ç»„ç®¡ç†å’Œåˆ†åŒºåˆ†é…
**ç›®æ ‡**: å®ç°æ™ºèƒ½çš„æ¶ˆè´¹è€…ç»„ç®¡ç†å’Œè´Ÿè½½å‡è¡¡

**æ ¸å¿ƒä»»åŠ¡**:
- å®ç°æ¶ˆè´¹è€…ç»„åè°ƒå™¨
- å»ºç«‹åˆ†åŒºåˆ†é…ç­–ç•¥ï¼ˆRoundRobinã€Stickyï¼‰
- å®ç°é‡å¹³è¡¡ç›‘å¬å’Œå¤„ç†
- æ·»åŠ æ¶ˆè´¹è€…å¥åº·ç›‘æ§

### ç¬¬äºŒé˜¶æ®µï¼šæ•°æ®å¤„ç†æµæ°´çº¿ï¼ˆç¬¬3-4å¤©ï¼‰

#### Step 2.2.3: æ¶ˆæ¯è§£æå’Œæ•°æ®éªŒè¯
**ç›®æ ‡**: å®ç°é«˜æ€§èƒ½çš„æ¶ˆæ¯è§£æå’Œæ•°æ®éªŒè¯

**æ ¸å¿ƒä»»åŠ¡**:
- å®ç°JSONæ¶ˆæ¯è§£æå™¨
- å»ºç«‹æ•°æ®éªŒè¯è§„åˆ™å¼•æ“
- å®ç°æ¶ˆæ¯æ ¼å¼å…¼å®¹æ€§å¤„ç†
- æ·»åŠ è§£ææ€§èƒ½ä¼˜åŒ–

#### Step 2.2.4: æ•°æ®è½¬æ¢å’Œä¸šåŠ¡å¤„ç†
**ç›®æ ‡**: å®ç°ä¸šåŠ¡é€»è¾‘å¤„ç†å’Œæ•°æ®è½¬æ¢

**æ ¸å¿ƒä»»åŠ¡**:
- å®ç°è®¾å¤‡æ•°æ®æ ‡å‡†åŒ–å¤„ç†
- å»ºç«‹ä¼ æ„Ÿå™¨æ•°æ®è½¬æ¢è§„åˆ™
- å®ç°å¼‚å¸¸æ£€æµ‹å’Œå‘Šè­¦è§¦å‘
- æ·»åŠ æ•°æ®èšåˆå’Œç»Ÿè®¡è®¡ç®—

### ç¬¬ä¸‰é˜¶æ®µï¼šæ ¸å¿ƒç‰¹æ€§å®ç°ï¼ˆç¬¬5å¤©ï¼‰

#### Step 2.2.5: åŸºç¡€ç›‘æ§å®ç°
**ç›®æ ‡**: å®ç°æ ¸å¿ƒçš„PrometheusæŒ‡æ ‡æ”¶é›†å’Œç›‘æ§

**æ ¸å¿ƒä»»åŠ¡**:
- âœ… å®ç°PrometheusæŒ‡æ ‡æ”¶é›†å™¨
- âœ… é›†æˆç°æœ‰Grafanaç›‘æ§ä»ªè¡¨æ¿
- âœ… é…ç½®å…³é”®æ€§èƒ½æŒ‡æ ‡å¯¼å‡º

**æŠ€æœ¯å®ç°è¦ç‚¹**:
```go
// æ¶ˆè´¹è€…PrometheusæŒ‡æ ‡å®šä¹‰
type ConsumerPrometheusMetrics struct {
    MessagesConsumed    prometheus.Counter
    ProcessingLatency   prometheus.Histogram  
    ProcessingErrors    prometheus.Counter
    ConsumerLag         prometheus.Gauge
    ActivePartitions    prometheus.Gauge
}
```

**é¢„æœŸæˆæœ**:
- å®Œæ•´çš„æ¶ˆè´¹è€…æ€§èƒ½æŒ‡æ ‡å¯¼å‡º
- ä¸ç°æœ‰Prometheus/Grafanaé›†æˆ
- å®æ—¶ç›‘æ§æ¶ˆè´¹è€…å¥åº·çŠ¶æ€

### ç¬¬å››é˜¶æ®µï¼šå…³é”®é›†æˆï¼ˆç¬¬6å¤©ï¼‰

#### Step 2.2.7: WebSocketå®æ—¶æ•°æ®æ¨é€
**ç›®æ ‡**: å®ç°æ¶ˆè´¹è€…åˆ°WebSocketçš„å®æ—¶æ•°æ®åˆ†å‘

**æ ¸å¿ƒä»»åŠ¡**:
- âœ… å®ç°æ•°æ®æ¨é€æ¥å£
- âœ… å»ºç«‹å®æ—¶æ•°æ®åˆ†å‘æœºåˆ¶
- âœ… é›†æˆæ¶ˆè´¹è€…å¤„ç†æµæ°´çº¿

**æŠ€æœ¯å®ç°è¦ç‚¹**:
```go
// WebSocketæ•°æ®æ¨é€æ¥å£
type DataPusher interface {
    PushDeviceData(ctx context.Context, data *models.DeviceDataPayload) error
    PushAlert(ctx context.Context, alert *models.AlertPayload) error
    GetConnectedClients() int
}

// é›†æˆåˆ°æ¶ˆæ¯å¤„ç†å™¨
type WebSocketIntegratedProcessor struct {
    *DefaultMessageProcessor
    dataPusher DataPusher
}
```

**é¢„æœŸæˆæœ**:
- å®æ—¶è®¾å¤‡æ•°æ®æ¨é€åˆ°WebSocketå®¢æˆ·ç«¯
- å‘Šè­¦æ¶ˆæ¯å³æ—¶åˆ†å‘
- å®Œæ•´çš„æ¶ˆè´¹è€…â†’WebSocketæ•°æ®æµ

## ğŸ—ï¸ æ ¸å¿ƒæ¶æ„è®¾è®¡è§„èŒƒ

### ç›®å½•ç»“æ„è®¾è®¡
```
cmd/consumer/
â”œâ”€â”€ main.go                    # æ¶ˆè´¹è€…ä¸»ç¨‹åº
â””â”€â”€ config.yaml               # é…ç½®æ–‡ä»¶

internal/services/consumer/
â”œâ”€â”€ kafka_consumer.go          # Kafkaæ¶ˆè´¹è€…æ ¸å¿ƒå®ç°
â”œâ”€â”€ consumer_group.go          # æ¶ˆè´¹è€…ç»„ç®¡ç†
â”œâ”€â”€ data_processor.go          # æ•°æ®å¤„ç†å™¨
â”œâ”€â”€ message_handler.go         # æ¶ˆæ¯å¤„ç†å™¨
â”œâ”€â”€ metrics_collector.go       # æŒ‡æ ‡æ”¶é›†å™¨
â””â”€â”€ error_handler.go           # é”™è¯¯å¤„ç†å™¨

internal/models/
â”œâ”€â”€ device.go                  # è®¾å¤‡æ•°æ®æ¨¡å‹
â”œâ”€â”€ message.go                 # æ¶ˆæ¯æ¨¡å‹
â””â”€â”€ metrics.go                 # æŒ‡æ ‡æ¨¡å‹

internal/config/
â””â”€â”€ consumer.go                # æ¶ˆè´¹è€…é…ç½®

deployments/docker/
â””â”€â”€ Dockerfile.consumer        # æ¶ˆè´¹è€…Dockeré•œåƒ
```

### æ ¸å¿ƒæ¥å£è®¾è®¡

#### æ¶ˆè´¹è€…æœåŠ¡æ¥å£
```go
type KafkaConsumerService interface {
    Start(ctx context.Context) error
    Stop() error
    Subscribe(topics []string) error
    GetMetrics() *ConsumerMetrics
    GetHealth() *HealthStatus
}

type ConsumerConfig struct {
    Brokers           []string      `yaml:"brokers"`
    GroupID           string        `yaml:"group_id"`
    Topics            []string      `yaml:"topics"`
    SessionTimeout    time.Duration `yaml:"session_timeout"`
    HeartbeatInterval time.Duration `yaml:"heartbeat_interval"`
    MaxPollRecords    int           `yaml:"max_poll_records"`
}
```

#### æ•°æ®å¤„ç†å™¨æ¥å£
```go
type DataProcessor interface {
    Process(ctx context.Context, message *Message) (*ProcessedData, error)
    ProcessBatch(ctx context.Context, messages []*Message) ([]*ProcessedData, error)
    GetStats() *ProcessingStats
}

type MessageHandler interface {
    HandleMessage(ctx context.Context, message *sarama.ConsumerMessage) error
    HandleBatch(ctx context.Context, messages []*sarama.ConsumerMessage) error
}
```

### é…ç½®è§„èŒƒ

#### æ¶ˆè´¹è€…é…ç½®
```yaml
kafka:
  brokers: ["192.168.5.16:9092"]
  consumer:
    group_id: "iot-consumer-group"
    topics: ["device-data"]
    auto_offset_reset: "earliest"
    session_timeout: "30s"
    heartbeat_interval: "3s"
    max_poll_records: 500
    enable_auto_commit: false

processing:
  worker_pool_size: 100
  batch_size: 50
  processing_timeout: "5s"
  
cache:
  redis:
    endpoints: ["redis:6379"]
    password: ""
    db: 0
    pool_size: 10

monitoring:
  prometheus:
    enabled: true
    port: 9090
    path: "/metrics"
```

### ç›‘æ§æŒ‡æ ‡å®šä¹‰

#### PrometheusæŒ‡æ ‡
```yaml
metrics:
  - name: "kafka_consumer_messages_consumed_total"
    type: "counter"
    help: "Total messages consumed"
  
  - name: "kafka_consumer_processing_duration_seconds"
    type: "histogram"
    help: "Message processing duration"
    buckets: [0.001, 0.005, 0.01, 0.05, 0.1, 0.5, 1.0]
  
  - name: "kafka_consumer_lag_messages"
    type: "gauge"
    help: "Consumer lag in messages"
```

## ğŸš€ Dockerå®¹å™¨åŒ–

### Dockerfileè®¾è®¡
```dockerfile
FROM golang:1.21-alpine AS builder
WORKDIR /app
COPY go.mod go.sum ./
RUN go mod download
COPY . .
RUN CGO_ENABLED=0 go build -o consumer ./cmd/consumer

FROM alpine:latest
RUN apk --no-cache add ca-certificates
WORKDIR /root/
COPY --from=builder /app/consumer .
COPY --from=builder /app/configs ./configs
EXPOSE 9090
CMD ["./consumer"]
```

### Docker Composeé›†æˆ
```yaml
version: '3.8'
services:
  consumer:
    build:
      context: .
      dockerfile: deployments/docker/Dockerfile.consumer
    environment:
      - KAFKA_BROKERS=kafka:9092
      - REDIS_ENDPOINT=redis:6379
    depends_on:
      - kafka
      - redis
    ports:
      - "9090:9090"
```

## ğŸ“Š æ€§èƒ½æµ‹è¯•é¢„æœŸç»“æœ

### ååé‡æµ‹è¯•
- **æ¶ˆæ¯å¤„ç†TPS**: 100,000+ æ¶ˆæ¯/ç§’
- **æ‰¹å¤„ç†æ€§èƒ½**: 50æ¡æ¶ˆæ¯/æ‰¹æ¬¡ï¼Œ2mså¤„ç†å»¶è¿Ÿ
- **å†…å­˜ä½¿ç”¨**: <1GB ç¨³å®šè¿è¡Œ
- **CPUä½¿ç”¨ç‡**: <60% æ­£å¸¸è´Ÿè½½

### å¯ç”¨æ€§æµ‹è¯•
- **æ•…éšœæ¢å¤æ—¶é—´**: <30ç§’è‡ªåŠ¨é‡å¹³è¡¡
- **æ¶ˆæ¯ä¸¢å¤±ç‡**: 0% (ç²¾ç¡®ä¸€æ¬¡è¯­ä¹‰)
- **ç³»ç»Ÿå¯ç”¨æ€§**: 99.9% æ­£å¸¸è¿è¡Œæ—¶é—´

## ğŸ¯ GitHubå±•ç¤ºè¦ç‚¹

### é¡¹ç›®äº®ç‚¹æ€»ç»“
- **é«˜å¹¶å‘å¤„ç†**: å±•ç¤ºæ¯ç§’10ä¸‡+æ¶ˆæ¯çš„å¤„ç†èƒ½åŠ›
- **åˆ†å¸ƒå¼æ¶æ„**: æ¶ˆè´¹è€…ç»„ç®¡ç†å’Œæ™ºèƒ½è´Ÿè½½å‡è¡¡
- **Goè¯­è¨€æœ€ä½³å®è·µ**: åç¨‹æ± ã€Channelç®¡é“ã€å†…å­˜ä¼˜åŒ–
- **ä¼ä¸šçº§ç‰¹æ€§**: ç›‘æ§ã€å‘Šè­¦ã€å®¹é”™ã€æ€§èƒ½è°ƒä¼˜

### æŠ€æœ¯èƒ½åŠ›å±•ç¤º
- **ç³»ç»Ÿè®¾è®¡èƒ½åŠ›**: å®Œæ•´çš„åˆ†å¸ƒå¼æ¶ˆæ¯å¤„ç†æ¶æ„
- **æ€§èƒ½ä¼˜åŒ–èƒ½åŠ›**: é«˜å¹¶å‘ã€ä½å»¶è¿Ÿçš„æŠ€æœ¯å®ç°
- **è¿ç»´èƒ½åŠ›**: ç›‘æ§ã€éƒ¨ç½²ã€æ•…éšœå¤„ç†çš„å®Œæ•´æ–¹æ¡ˆ

---

*æœ¬æ–‡æ¡£ä¸ºStep 2.2 Kafkaæ¶ˆè´¹è€…çš„å®Œæ•´æ¶æ„è®¾è®¡ï¼Œä¸ºAIå®ç°æä¾›è¯¦ç»†çš„æŠ€æœ¯è§„èŒƒå’Œæ¥å£å®šä¹‰ã€‚*
